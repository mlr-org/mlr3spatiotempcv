---
title: "Spatiotemporal Visualization"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{spatiotemp-viz}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
os = ifelse(!Sys.info()[["sysname"]] == "Darwin", TRUE, FALSE)

# - dont run on CRAN
# - only download if exec if missing
is_cran = ifelse(Sys.getenv("NOT_CRAN") != "false", FALSE, TRUE)
if (!is_cran && os) {
  if (!file.exists(system.file("vcluster", package = "mlr3spatiotempcv")) &
    !file.exists(system.file("vcluster.exe", package = "mlr3spatiotempcv"))
  ) {
    source("https://gist.githubusercontent.com/pat-s/6430470cf817050e27d26c43c0e9be72/raw/c90480893fdd57ce990795a702aada41382e03a9/install-cluto.R", echo = TRUE) # nolint
  }
}
```

{mlr3spatiotempcv} makes use of {plotly} to create the 3D plots for visualizing spatiotemporal folds created via the CLUTO algorithm.
Arranging multiple 3D plots in plotly is done via [3D subplots](https://plotly.com/r/3d-subplots/).
Unfortunately, {plotl's} subplot implementation is not dynamic: multiple "scene" objects need to be specified in `plotly::layout()` which determine the coordinates of the respective subplot.
Depending on the number of chosen folds by the user in `autoplot()`, a different number of scenes with different coordinates needs to be given to align the plots properly.

At this point, manual action by the user is needed.

Here is an example to create a 2x2 grid showing four folds as 3D subplots.
It makes use of the returned 3D plotly objects which are returned in a list by `autoplot()`:

```{r, fig.width=9, fig.height=8, fig.align='center', eval=os&&!is_cran}
library(mlr3)
library(mlr3spatiotempcv)
task_st = tsk("cookfarm")
resampling = rsmp("spcv-cluto", folds = 5)
resampling$instantiate(task_st, time_var = "Date")

pl = autoplot(resampling, task_st, c(1, 2, 3, 4),
  point_size = 3, axis_label_fontsize = 10)

# Warnings can be ignored
pl_subplot = plotly::subplot(pl)

plotly::layout(pl_subplot,
  title = "Individual Folds",
  scene = list(
    domain = list(x = c(0, 0.5), y = c(0.5, 1)),
    aspectmode = "cube",
    camera = list(eye = list(z = 2.5))
  ),
  scene2 = list(
    domain = list(x = c(0.5, 1), y = c(0.5, 1)),
    aspectmode = "cube",
    camera = list(eye = list(z = 2.5))
  ),
  scene3 = list(
    domain = list(x = c(0, 0.5), y = c(0, 0.5)),
    aspectmode = "cube",
    camera = list(eye = list(z = 2.5))
  ),
  scene4 = list(
    domain = list(x = c(0.5, 1), y = c(0, 0.5)),
    aspectmode = "cube",
    camera = list(eye = list(z = 2.5))
  )
)
```

Subplot titles are not dynamically supported.
However, there is also a manual workaround via [annotations](https://plotly.com/r/reference/#layout-annotations) show in this [RPubs post](https://rpubs.com/bcd/subplot-titles) which could be used.
